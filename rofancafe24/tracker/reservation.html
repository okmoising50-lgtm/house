<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 관리 - 카페24</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 1400px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-calendar-event"></i> 예약 관리</h1>
            <div>
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house"></i> 홈</a>
                <a href="admin.html" class="btn btn-secondary me-2"><i class="bi bi-gear"></i> 관리자</a>
                <a href="attendance.html" class="btn btn-info me-2"><i class="bi bi-calendar-check"></i> 일자별 출근부</a>
                <button class="btn btn-primary" onclick="showAddModal()"><i class="bi bi-plus-circle"></i> 예약 오더 추가</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 예약 오더 목록</h5>
            </div>
            <div class="card-body p-0" id="orderList">
                <div class="text-center p-5"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>
    </div>

    <!-- 예약 오더 추가/수정 모달 -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">예약 오더 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <div class="mb-3">
                            <label for="staffName" class="form-label">매니저 이름 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="staffName" name="staff_name" required placeholder="예: 김나나">
                        </div>
                        <div class="mb-3">
                            <label for="timeRangeStart" class="form-label">시간 범위 시작 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="timeRangeStart" name="time_range_start" min="0" max="23" required placeholder="예: 18">
                        </div>
                        <div class="mb-3">
                            <label for="timeRangeEnd" class="form-label">시간 범위 끝 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="timeRangeEnd" name="time_range_end" min="0" max="23" required placeholder="예: 20">
                        </div>
                        <div class="mb-3">
                            <label for="conditionType" class="form-label">조건 <span class="text-danger">*</span></label>
                            <select class="form-select" id="conditionType" name="condition_type" required>
                                <option value="latest">가장 늦은시간</option>
                                <option value="earliest">가장 빠른시간</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="timeCount" class="form-label">타임 수 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="timeCount" name="time_count" min="1" value="1" required>
                            <small class="form-text text-muted">1타임 = 가장 늦은시간 1개, 2타임 = 가장 늦은시간 2개</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="testMode" name="test_mode" value="1">
                                <label class="form-check-label" for="testMode">테스트 모드</label>
                            </div>
                        </div>
                        <div class="mb-3" id="testPhoneGroup" style="display: none;">
                            <label for="testPhone" class="form-label">테스트 전화번호</label>
                            <input type="text" class="form-control" id="testPhone" name="test_phone" placeholder="010-1234-5678">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrder()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let orderModal;
        
        $(document).ready(function() {
            orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
            loadOrders();
            loadSettings();
            
            // 테스트 모드 체크박스 이벤트
            $('#testMode').change(function() {
                if ($(this).is(':checked')) {
                    $('#testPhoneGroup').show();
                } else {
                    $('#testPhoneGroup').hide();
                }
            });
        });

        function loadSettings() {
            $.ajax({
                url: 'api/get_settings.php',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        const settings = response.data;
                        if (settings.test_mode_enabled == '1') {
                            $('#testMode').prop('checked', true);
                            $('#testPhoneGroup').show();
                        }
                        if (settings.test_phone_number) {
                            $('#testPhone').val(settings.test_phone_number);
                        }
                    }
                }
            });
        }

        function showAddModal() {
            $('#orderForm')[0].reset();
            $('#modalTitle').text('예약 오더 추가');
            $('#testMode').prop('checked', false);
            $('#testPhoneGroup').hide();
            orderModal.show();
        }

        function saveOrder() {
            const formData = {
                staff_name: $('#staffName').val(),
                time_range_start: parseInt($('#timeRangeStart').val()),
                time_range_end: parseInt($('#timeRangeEnd').val()),
                condition_type: $('#conditionType').val(),
                time_count: parseInt($('#timeCount').val()),
                test_mode: $('#testMode').is(':checked') ? 1 : 0,
                test_phone: $('#testPhone').val()
            };

            if (!formData.staff_name || !formData.time_range_start || !formData.time_range_end) {
                alert('필수 항목을 입력하세요.');
                return;
            }

            $.ajax({
                url: 'api/save_order.php',
                method: 'POST',
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        orderModal.hide();
                        loadOrders();
                        alert('예약 오더가 추가되었습니다.');
                    } else {
                        alert('저장 실패: ' + (response?.message || '알 수 없는 오류'));
                    }
                },
                error: function() {
                    alert('서버 오류가 발생했습니다.');
                }
            });
        }

        function loadOrders() {
            $.ajax({
                url: 'api/get_orders.php',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderOrders(response.data);
                    } else {
                        $('#orderList').html('<div class="alert alert-danger m-3">데이터 로딩 실패</div>');
                    }
                },
                error: function() {
                    $('#orderList').html('<div class="alert alert-danger m-3">서버 연결 실패</div>');
                }
            });
        }

        function renderOrders(orders) {
            if (!orders || orders.length === 0) {
                $('#orderList').html('<div class="text-center p-5 text-muted">예약 오더가 없습니다.</div>');
                return;
            }

            let html = '';
            orders.forEach(function(order) {
                const statusBadge = {
                    'pending': '<span class="badge bg-warning">대기중</span>',
                    'processing': '<span class="badge bg-info">처리중</span>',
                    'completed': '<span class="badge bg-success">완료</span>',
                    'failed': '<span class="badge bg-danger">실패</span>'
                }[order.status] || '<span class="badge bg-secondary">알 수 없음</span>';

                const conditionText = order.condition_type == 'latest' ? '가장 늦은시간' : '가장 빠른시간';
                const testModeBadge = order.test_mode == '1' ? '<span class="badge bg-secondary">테스트</span>' : '';

                html += `
                    <div class="card m-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${escapeHtml(order.staff_name)} ${statusBadge} ${testModeBadge}</h5>
                                    <p class="card-text">
                                        시간 범위: ${order.time_range_start}시 ~ ${order.time_range_end}시<br>
                                        조건: ${conditionText}, 타임 수: ${order.time_count}<br>
                                        <small class="text-muted">생성: ${order.created_at || ''}</small>
                                    </p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.order_id})"><i class="bi bi-trash"></i> 삭제</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#orderList').html(html);
        }

        function deleteOrder(orderId) {
            if (!confirm('정말로 이 예약 오더를 삭제하시겠습니까?')) {
                return;
            }

            $.ajax({
                url: 'api/delete_order.php',
                method: 'POST',
                data: { order_id: orderId },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        loadOrders();
                        alert('삭제되었습니다.');
                    } else {
                        alert('삭제 실패: ' + (response?.message || '알 수 없는 오류'));
                    }
                },
                error: function() {
                    alert('서버 오류가 발생했습니다.');
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>


