<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì´íŠ¸ë³„ ë¡œê·¸ - ì¹´í˜24</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 1600px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .site-list-item { 
            padding: 15px; 
            border-bottom: 1px solid #e9ecef; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .site-list-item:hover { background-color: #f8f9fa; }
        .site-list-item.active { background-color: #e7f3ff; border-left: 4px solid #0d6efd; }
        .change-item { border-bottom: 1px solid #e9ecef; padding: 20px; }
        .change-item.unread { background-color: #fff3cd; }
        .diff-content { background-color: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; line-height: 1.8; }
        .diff-added { background-color: #d4edda !important; color: #155724 !important; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .diff-removed { background-color: #f8d7da !important; color: #721c24 !important; text-decoration: line-through; padding: 2px 4px; border-radius: 3px; }
        .site-summary { font-size: 0.9rem; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-check"></i> ì‚¬ì´íŠ¸ë³„ ë¡œê·¸</h1>
            <div>
                <button class="btn btn-warning me-2" id="notificationStatusBtn" onclick="requestNotificationPermission()">
                    <i class="bi bi-bell-slash" id="notificationIcon"></i> <span id="notificationStatusText">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</span>
                </button>
                <div class="btn-group me-2">
                    <button class="btn btn-sm btn-outline-secondary" id="refreshToggleBtn" onclick="toggleRefresh()">
                        <i class="bi bi-pause-circle" id="refreshToggleIcon"></i> <span id="refreshToggleText">ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€</span>
                    </button>
                    <input type="number" class="form-control form-control-sm" id="refreshIntervalInput" value="1" min="1" max="60" style="width: 80px; display: inline-block;" onchange="updateRefreshInterval()">
                    <span class="input-group-text" style="display: inline-block; padding: 0.375rem 0.5rem;">ì´ˆ</span>
                </div>
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house"></i> í™ˆ</a>
                <a href="admin.html" class="btn btn-secondary me-2"><i class="bi bi-gear"></i> ê´€ë¦¬ì</a>
                <a href="changes.html" class="btn btn-info me-2"><i class="bi bi-clock-history"></i> ì „ì²´ ë³€í™” ë¡œê·¸</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-globe"></i> ëª¨ë‹ˆí„°ë§ ì‚¬ì´íŠ¸</h5>
                    </div>
                    <div class="card-body p-0" id="siteList" style="max-height: 80vh; overflow-y: auto;">
                        <div class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0" id="selectedSiteTitle">
                            <i class="bi bi-list-check"></i> ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”
                        </h5>
                    </div>
                    <div class="card-body p-0" id="changeList" style="max-height: 80vh; overflow-y: auto;">
                        <div id="attendanceInfoSite" style="background-color: #fff3cd; padding: 15px; border-bottom: 2px solid #ffc107; margin: 0; display: none;">
                            <div class="text-center"><div class="spinner-border spinner-border-sm text-warning"></div> ì¶œê·¼ë¶€ ì •ë³´ ë¡œë”© ì¤‘...</div>
                        </div>
                        <div class="text-center p-5 text-muted">ì™¼ìª½ì—ì„œ ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> ì „ì²´ ë³€í™” ë¡œê·¸</h5>
                    </div>
                    <div class="card-body p-0" id="allChangeList" style="max-height: 80vh; overflow-y: auto;">
                        <div class="text-center p-5"><div class="spinner-border text-success"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedSiteId = null;
        
        let refreshInterval = null;
        let lastChangeId = 0;
        let refreshEnabled = true;
        let refreshIntervalMs = 1000; // ê¸°ë³¸ 1ì´ˆ
        let notificationPermission = false;
        let notifiedChangeIds = new Set(); // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ change_id ì¶”ì 
        
        $(document).ready(function() {
            if (typeof jQuery === 'undefined') {
                document.getElementById('siteList').innerHTML = '<div class="alert alert-danger m-3">jQueryë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const savedRefreshEnabled = localStorage.getItem('siteLogs_refreshEnabled');
            const savedRefreshInterval = localStorage.getItem('siteLogs_refreshInterval');
            
            if (savedRefreshEnabled !== null) {
                refreshEnabled = savedRefreshEnabled === 'true';
            }
            if (savedRefreshInterval !== null) {
                refreshIntervalMs = parseInt(savedRefreshInterval) * 1000;
                $('#refreshIntervalInput').val(refreshIntervalMs / 1000);
            }
            
            updateRefreshToggleUI();
            checkNotificationPermission();
            
            loadSites();
            loadAllChanges(); // ì´ˆê¸° ë¡œë“œ
            
            // ìƒˆ ë³€í™” ì²´í¬ ì‹œì‘
            checkNewChanges();
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
            startRefresh();
            
            // í˜ì´ì§€ê°€ ë³´ì´ì§€ ì•Šì„ ë•ŒëŠ” ì—…ë°ì´íŠ¸ ì¤‘ì§€
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopRefresh();
                } else {
                    if (refreshEnabled) {
                        startRefresh();
                    }
                }
            });
        });
        
        function startRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (refreshEnabled) {
                refreshInterval = setInterval(function() {
                    if (selectedSiteId) {
                        loadSiteAttendance(selectedSiteId);
                        loadSiteChanges(selectedSiteId);
                    }
                    // ì „ì²´ ë¡œê·¸ë„ ì—…ë°ì´íŠ¸
                    loadAllChanges();
                    // ìƒˆ ë³€í™” ì²´í¬
                    checkNewChanges();
                }, refreshIntervalMs);
            }
        }
        
        function stopRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function toggleRefresh() {
            refreshEnabled = !refreshEnabled;
            localStorage.setItem('siteLogs_refreshEnabled', refreshEnabled);
            
            if (refreshEnabled) {
                startRefresh();
            } else {
                stopRefresh();
            }
            
            updateRefreshToggleUI();
        }
        
        function updateRefreshInterval() {
            const seconds = parseInt($('#refreshIntervalInput').val()) || 1;
            if (seconds < 1) {
                $('#refreshIntervalInput').val(1);
                refreshIntervalMs = 1000;
            } else {
                refreshIntervalMs = seconds * 1000;
            }
            localStorage.setItem('siteLogs_refreshInterval', seconds);
            
            if (refreshEnabled) {
                startRefresh();
            }
        }
        
        function updateRefreshToggleUI() {
            if (refreshEnabled) {
                $('#refreshToggleIcon').removeClass('bi-pause-circle').addClass('bi-play-circle');
                $('#refreshToggleText').text('ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€');
            } else {
                $('#refreshToggleIcon').removeClass('bi-play-circle').addClass('bi-pause-circle');
                $('#refreshToggleText').text('ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            }
        }
        
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                    updateNotificationUI('granted');
                } else if (Notification.permission === 'denied') {
                    notificationPermission = false;
                    updateNotificationUI('denied');
                } else {
                    notificationPermission = false;
                    updateNotificationUI('default');
                }
            } else {
                updateNotificationUI('not-supported');
            }
        }
        
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            Notification.requestPermission().then(function(permission) {
                updateNotificationUI(permission);
                if (permission === 'granted') {
                    notificationPermission = true;
                    alert('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ë³€í™”ê°€ ê°ì§€ë˜ë©´ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.');
                    showTestNotification();
                } else {
                    notificationPermission = false;
                    alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }).catch(function(err) {
                console.error('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
                alert('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        function updateNotificationUI(permission) {
            const icon = $('#notificationIcon');
            const text = $('#notificationStatusText');
            
            if (permission === 'granted') {
                icon.removeClass('bi-bell-slash').addClass('bi-bell-fill');
                text.text('ì•Œë¦¼ í™œì„±í™”ë¨');
            } else if (permission === 'denied') {
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê±°ë¶€ë¨');
            } else if (permission === 'not-supported') {
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ë¯¸ì§€ì›');
            } else {
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­');
            }
        }
        
        function showTestNotification() {
            if (Notification.permission === 'granted') {
                const notification = new Notification('ì•Œë¦¼ í…ŒìŠ¤íŠ¸', {
                    body: 'ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!',
                    icon: '/favicon.ico'
                });
                setTimeout(() => notification.close(), 3000);
            }
        }
        
        function checkNewChanges() {
            if (typeof jQuery === 'undefined') {
                return;
            }
            
            // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ ì¬í™•ì¸
            if ('Notification' in window) {
                notificationPermission = Notification.permission === 'granted';
            }
            
            jQuery.ajax({
                url: 'api/get_new_changes.php',
                method: 'GET',
                data: { last_change_id: lastChangeId },
                dataType: 'json',
                timeout: 5000,
                success: function(response) {
                    try {
                        if (response && response.success && response.data && response.data.length > 0) {
                            console.log('ìƒˆë¡œìš´ ë³€í™” ê°ì§€:', response.data.length, 'ê°œ');
                            
                            // ìƒˆë¡œìš´ ë³€í™”ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
                            response.data.forEach(function(change) {
                                if (change.change_id > lastChangeId) {
                                    lastChangeId = change.change_id;
                                }
                                
                                // ì„ íƒëœ ì‚¬ì´íŠ¸ì˜ ë³€í™”ë§Œ ì•Œë¦¼ í‘œì‹œ
                                if (selectedSiteId && change.site_id == selectedSiteId) {
                                    // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ change_idëŠ” ê±´ë„ˆë›°ê¸°
                                    if (!notifiedChangeIds.has(change.change_id) && notificationPermission) {
                                        notifiedChangeIds.add(change.change_id);
                                        showNotification(change);
                                    }
                                }
                            });
                            
                            // í˜ì´ì§€ê°€ ë³´ì´ëŠ” ìƒíƒœë©´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                            if (!document.hidden && refreshEnabled) {
                                if (selectedSiteId) {
                                    loadSiteChanges(selectedSiteId);
                                }
                                loadAllChanges();
                            }
                        }
                    } catch (error) {
                        console.error('ìƒˆ ë³€í™” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    }
                },
                error: function(xhr, status, error) {
                    // ì¡°ìš©íˆ ì‹¤íŒ¨ (ì—ëŸ¬ ë¡œê·¸ë§Œ)
                    console.error('ìƒˆ ë³€í™” ì²´í¬ ì‹¤íŒ¨:', error);
                }
            });
        }
        
        function showNotification(change) {
            if (!notificationPermission) {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì—†ì–´ ì•Œë¦¼ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë³€í™” ìš”ì•½ ìƒì„±
            let changeSummary = 'ë‚´ìš© ë³€ê²½ë¨';
            if (change.diff_html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = change.diff_html;
                const text = tempDiv.textContent || tempDiv.innerText || '';
                changeSummary = text.substring(0, 100).trim();
                if (text.length > 100) {
                    changeSummary += '...';
                }
            }
            
            const title = 'ğŸ”” ë³€í™” ê°ì§€: ' + (change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ');
            const body = changeSummary + '\n\nì‹œê°„: ' + (change.detected_at || 'ë°©ê¸ˆ ì „');
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: '/favicon.ico',
                    tag: 'change_' + change.change_id,
                    requireInteraction: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // 5ì´ˆ í›„ ìë™ ë‹«ê¸°
                setTimeout(() => notification.close(), 5000);
                
                console.log('ì•Œë¦¼ í‘œì‹œë¨:', title);
            } catch (error) {
                console.error('ì•Œë¦¼ í‘œì‹œ ì‹¤íŒ¨:', error);
            }
        }
        
        function loadSites() {
            jQuery.ajax({
                url: 'api/get_sites.php',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderSites(response.data);
                    } else {
                        jQuery('#siteList').html('<div class="alert alert-danger m-3">ì‚¬ì´íŠ¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ì‚¬ì´íŠ¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                    jQuery('#siteList').html('<div class="alert alert-danger m-3">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</div>');
                }
            });
        }
        
        function renderSites(sites) {
            if (!sites || sites.length === 0) {
                jQuery('#siteList').html('<div class="text-center p-5 text-muted">ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }
            
            let html = '';
            sites.forEach(function(site) {
                html += `
                    <div class="site-list-item" onclick="selectSite(${site.site_id}, '${escapeHtml(site.site_name)}')" id="site-${site.site_id}">
                        <h6 class="mb-1">${escapeHtml(site.site_name)}</h6>
                        <p class="mb-1 site-summary"><small>${escapeHtml(site.site_url)}</small></p>
                        <p class="mb-0 site-summary"><small>ë§ˆì§€ë§‰ ì²´í¬: ${site.last_check_time || 'ì•„ì§ ì²´í¬ë˜ì§€ ì•ŠìŒ'}</small></p>
                    </div>
                `;
            });
            jQuery('#siteList').html(html);
        }
        
        function selectSite(siteId, siteName) {
            selectedSiteId = siteId;
            
            // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
            jQuery('.site-list-item').removeClass('active');
            jQuery('#site-' + siteId).addClass('active');
            
            // ì œëª© ì—…ë°ì´íŠ¸
            jQuery('#selectedSiteTitle').html(`<i class="bi bi-list-check"></i> ${escapeHtml(siteName)} - ë³€í™” ë¡œê·¸`);
            
            // ì¶œê·¼ë¶€ ì •ë³´ ë¡œë“œ
            loadSiteAttendance(siteId);
            
            // ë³€í™” ë¡œê·¸ ë¡œë“œ
            loadSiteChanges(siteId);
        }
        
        function loadSiteChanges(siteId) {
            jQuery('#changeList').html('<div class="text-center p-5"><div class="spinner-border text-info"></div></div>');
            
            jQuery.ajax({
                url: 'api/get_changes.php',
                method: 'GET',
                data: { site_id: siteId, limit: 100 },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderSiteChanges(response.data);
                    } else {
                        jQuery('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ë³€í™” ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨:', error);
                    jQuery('#changeList').html('<div class="alert alert-danger m-3">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</div>');
                }
            });
        }
        
        function loadSiteAttendance(siteId) {
            if (typeof jQuery === 'undefined') return;
            
            jQuery('#attendanceInfoSite').show();
            
            const today = new Date().toISOString().split('T')[0];
            jQuery.ajax({
                url: 'api/get_attendance.php',
                method: 'GET',
                data: { date: today, site_id: siteId },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderSiteAttendanceInfo(response.data);
                    } else {
                        jQuery('#attendanceInfoSite').html('<div style="text-align: center; padding: 10px; color: #856404;"><i class="bi bi-info-circle"></i> ì¶œê·¼ì¸ì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
                    }
                },
                error: function() {
                    jQuery('#attendanceInfoSite').html('<div style="text-align: center; padding: 10px; color: #856404;"><i class="bi bi-info-circle"></i> ì¶œê·¼ì¸ì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
                }
            });
        }
        
        function renderSiteAttendanceInfo(attendanceRecords) {
            if (typeof jQuery === 'undefined') return;
            
            if (!attendanceRecords || attendanceRecords.length === 0) {
                jQuery('#attendanceInfoSite').html('<div style="text-align: center; padding: 10px; color: #856404;"><i class="bi bi-info-circle"></i> ì¶œê·¼ì¸ì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
                return;
            }
            
            let html = '<div style="font-weight: bold; margin-bottom: 10px; color: #856404;"><i class="bi bi-calendar-check"></i> ì˜¤ëŠ˜ ì¶œê·¼ë¶€ (' + new Date().toLocaleDateString('ko-KR') + ')</div>';
            let staffList = [];
            attendanceRecords.forEach(function(record) {
                const times = record.work_times || '';
                staffList.push(escapeHtml(record.staff_name) + ' ' + escapeHtml(times));
            });
            html += '<div>' + staffList.join(' | ') + '</div>';
            
            jQuery('#attendanceInfoSite').html(html);
        }

        function renderSiteChanges(changes) {
            if (!changes || changes.length === 0) {
                // ì¶œê·¼ë¶€ ì •ë³´ëŠ” ìœ ì§€
                const attendanceHtml = jQuery('#attendanceInfoSite').html();
                jQuery('#changeList').html(attendanceHtml + '<div class="text-center p-5 text-muted">ì´ ì‚¬ì´íŠ¸ì˜ ë³€í™” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }
            
            let html = '';
            changes.forEach(function(change) {
                const unreadClass = change.is_read == '0' ? 'unread' : '';
                const readBadge = change.is_read == '0' ? '<span class="badge bg-warning text-dark">NEW</span>' : '<span class="badge bg-secondary">ì½ìŒ</span>';
                
                // ë³€í™” ìš”ì•½ ìƒì„± (ê°„ë‹¨í•œ í˜•ì‹)
                const changeSummary = formatChangeSummary(change);
                
                // ì‹œê°„ í¬ë§·íŒ… (YYYY-MM-DD HH:MM:SS -> HH:MM:SS)
                const timeOnly = change.detected_at ? change.detected_at.split(' ')[1] || change.detected_at : 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                const siteName = change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                html += `
                    <div class="change-item ${unreadClass}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${readBadge} <strong>${escapeHtml(siteName)}</strong> <span class="text-muted">${timeOnly}</span></h6>
                            </div>
                        </div>
                        <div class="change-summary mb-2" style="font-size: 1.1rem; font-weight: 500;">
                            ${changeSummary}
                        </div>
                        <details>
                            <summary class="text-muted" style="cursor: pointer; font-size: 0.9rem;">â–¶ ìƒì„¸ ë‚´ìš© ë³´ê¸°</summary>
                            <div class="diff-content mt-2">${change.diff_html || 'ë³€í™” ë‚´ìš© ì—†ìŒ'}</div>
                        </details>
                    </div>
                `;
            });
            // ì¶œê·¼ë¶€ ì •ë³´ëŠ” ìœ ì§€í•˜ê³  ë³€í™” ë¡œê·¸ë§Œ ì¶”ê°€
            const attendanceHtml = jQuery('#attendanceInfoSite').html();
            jQuery('#changeList').html(attendanceHtml + html);
        }
        
        function formatChangeSummary(change) {
            if (!change || !change.diff_html) {
                return '<span class="text-muted">ë³€í™” ë‚´ìš© ì—†ìŒ</span>';
            }
            
            try {
                // diff_html íŒŒì‹±í•˜ì—¬ ì‹¤ì œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = change.diff_html || '';
            
            // ëª¨ë“  ë…¸ë“œë¥¼ ìˆœíšŒí•˜ì—¬ ë³€í™” ì „í›„ í…ìŠ¤íŠ¸ êµ¬ì„±
            let beforeParts = [];
            let afterParts = [];
            
            function extractParts(node) {
                if (node.nodeType === 3) { // í…ìŠ¤íŠ¸ ë…¸ë“œ
                    const text = node.textContent.trim();
                    if (text) {
                        beforeParts.push({ type: 'text', content: text });
                        afterParts.push({ type: 'text', content: text });
                    }
                } else if (node.nodeType === 1) { // ìš”ì†Œ ë…¸ë“œ
                    const className = node.className || '';
                    const text = node.textContent.trim();
                    
                    if (className.includes('diff-removed')) {
                        // ì‚­ì œëœ ë¶€ë¶„ë§Œ beforePartsì— ì¶”ê°€
                        beforeParts.push({ type: 'removed', content: text });
                    } else if (className.includes('diff-added')) {
                        // ì¶”ê°€ëœ ë¶€ë¶„ë§Œ afterPartsì— ì¶”ê°€
                        afterParts.push({ type: 'added', content: text });
                    } else {
                        // ìì‹ ë…¸ë“œ ì¬ê·€ ì²˜ë¦¬
                        for (let child of node.childNodes) {
                            extractParts(child);
                        }
                    }
                }
            }
            
            extractParts(tempDiv);
            
            // ë³€í™” ì „í›„ í…ìŠ¤íŠ¸ êµ¬ì„±
            let beforeText = '';
            let afterText = '';
            let removedOnly = '';
            let addedOnly = '';
            
            beforeParts.forEach(part => {
                if (part.type === 'text') {
                    beforeText += part.content + ' ';
                } else if (part.type === 'removed') {
                    beforeText += part.content + ' ';
                    removedOnly = part.content;
                }
            });
            
            afterParts.forEach(part => {
                if (part.type === 'text') {
                    afterText += part.content + ' ';
                } else if (part.type === 'added') {
                    afterText += part.content + ' ';
                    addedOnly = part.content;
                }
            });
            
            beforeText = beforeText.trim();
            afterText = afterText.trim();
            
            // ì‹¤ì œë¡œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ê³µí†µ ë¶€ë¶„ ì œì™¸)
            let summary = '';
            if (removedOnly && addedOnly) {
                // ê³µí†µ ë¶€ë¶„ ì°¾ê¸° (LCS)
                const commonPrefix = findCommonPrefix(removedOnly, addedOnly);
                const commonSuffix = findCommonSuffix(removedOnly, addedOnly);
                
                let removedDiff = removedOnly;
                let addedDiff = addedOnly;
                
                if (commonPrefix) {
                    removedDiff = removedOnly.substring(commonPrefix.length);
                    addedDiff = addedOnly.substring(commonPrefix.length);
                }
                if (commonSuffix && removedDiff.endsWith(commonSuffix) && addedDiff.endsWith(commonSuffix)) {
                    removedDiff = removedDiff.substring(0, removedDiff.length - commonSuffix.length);
                    addedDiff = addedDiff.substring(0, addedDiff.length - commonSuffix.length);
                }
                
                // beforeTextì—ì„œ removedOnly ë¶€ë¶„ì„ ì°¾ì•„ì„œ ì¤„ì²˜ë¦¬
                let beforeDisplay = beforeText;
                if (beforeDisplay.includes(removedOnly)) {
                    beforeDisplay = beforeDisplay.replace(
                        removedOnly, 
                        removedOnly.substring(0, removedOnly.length - removedDiff.length) + 
                        `<u class="text-danger">${escapeHtml(removedDiff)}</u>`
                    );
                }
                
                // afterTextëŠ” removedOnly ì œê±°í•˜ê³  addedOnly ì¶”ê°€
                let afterDisplay = afterText.replace(removedOnly, '').trim();
                if (afterDisplay.includes(addedOnly)) {
                    // addedOnlyì—ì„œ ì‹¤ì œ ì¶”ê°€ëœ ë¶€ë¶„ë§Œ ê°•ì¡°
                    const addedHighlight = addedOnly.substring(addedOnly.length - addedDiff.length);
                    afterDisplay = afterDisplay.replace(
                        addedOnly,
                        addedOnly.substring(0, addedOnly.length - addedDiff.length) + 
                        `<span class="text-success fw-bold">${escapeHtml(addedHighlight)}</span>`
                    );
                }
                
                summary = `${beforeDisplay} â†’ ${afterDisplay}`;
            } else if (removedOnly) {
                let beforeDisplay = beforeText;
                if (beforeDisplay.includes(removedOnly)) {
                    beforeDisplay = beforeDisplay.replace(
                        removedOnly,
                        `<u class="text-danger">${escapeHtml(removedOnly)}</u>`
                    );
                }
                summary = `${beforeDisplay} â†’ <span class="text-muted">(ì‚­ì œë¨)</span>`;
            } else if (addedOnly) {
                let afterDisplay = afterText;
                if (afterDisplay.includes(addedOnly)) {
                    afterDisplay = afterDisplay.replace(
                        addedOnly,
                        `<span class="text-success fw-bold">${escapeHtml(addedOnly)}</span>`
                    );
                }
                summary = `${escapeHtml(beforeText)} â†’ ${afterDisplay}`;
            } else {
                summary = '<span class="text-muted">ë‚´ìš© ë³€ê²½ë¨</span>';
            }
            
            return summary;
            } catch (error) {
                console.error('formatChangeSummary error:', error);
                return '<span class="text-muted">ë³€í™” ë‚´ìš© íŒŒì‹± ì˜¤ë¥˜</span>';
            }
        }
        
        function findCommonPrefix(str1, str2) {
            let prefix = '';
            const minLen = Math.min(str1.length, str2.length);
            for (let i = 0; i < minLen; i++) {
                if (str1[i] === str2[i]) {
                    prefix += str1[i];
                } else {
                    break;
                }
            }
            return prefix;
        }
        
        function findCommonSuffix(str1, str2) {
            let suffix = '';
            const minLen = Math.min(str1.length, str2.length);
            for (let i = 1; i <= minLen; i++) {
                if (str1[str1.length - i] === str2[str2.length - i]) {
                    suffix = str1[str1.length - i] + suffix;
                } else {
                    break;
                }
            }
            return suffix;
        }
        
        function loadAllChanges() {
            jQuery.ajax({
                url: 'api/get_changes.php',
                method: 'GET',
                data: { limit: 50 },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderAllChanges(response.data);
                    } else {
                        jQuery('#allChangeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ì „ì²´ ë³€í™” ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨:', error);
                    jQuery('#allChangeList').html('<div class="alert alert-danger m-3">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</div>');
                }
            });
        }
        
        function renderAllChanges(changes) {
            if (!changes || changes.length === 0) {
                jQuery('#allChangeList').html('<div class="text-center p-5 text-muted">ë³€í™” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }
            
            let html = '';
            changes.forEach(function(change) {
                const unreadClass = change.is_read == '0' ? 'unread' : '';
                const readBadge = change.is_read == '0' ? '<span class="badge bg-warning text-dark">NEW</span>' : '';
                
                // ì‹œê°„ í¬ë§·íŒ… (YYYY-MM-DD HH:MM:SS -> HH:MM:SS)
                const timeOnly = change.detected_at ? change.detected_at.split(' ')[1] || change.detected_at : 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                html += `
                    <div class="change-item ${unreadClass}" style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${readBadge} <strong>${escapeHtml(change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ')}</strong> <span class="text-muted">${timeOnly}</span></h6>
                            </div>
                        </div>
                        <div class="change-summary mb-2" style="font-size: 0.95rem;">
                            ${formatChangeSummary(change)}
                        </div>
                        <details>
                            <summary class="text-muted" style="cursor: pointer; font-size: 0.85rem;">ìƒì„¸ ë‚´ìš© ë³´ê¸°</summary>
                            <div class="diff-content mt-2" style="font-size: 0.85rem;">${change.diff_html || 'ë³€í™” ë‚´ìš© ì—†ìŒ'}</div>
                        </details>
                    </div>
                `;
            });
            jQuery('#allChangeList').html(html);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

