<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ ëª¨ë‹ˆí„°ë§ ë³€í™” ë¡œê·¸ - ì¹´í˜24</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 1600px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .change-item { border-bottom: 1px solid #e9ecef; padding: 20px; }
        .change-item.unread { background-color: #fff3cd; }
        .diff-content { background-color: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; line-height: 1.8; }
        .diff-added { background-color: #d4edda !important; color: #155724 !important; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .diff-removed { background-color: #f8d7da !important; color: #721c24 !important; text-decoration: line-through; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-clock-history"></i> ì›¹ ëª¨ë‹ˆí„°ë§ ë³€í™” ë¡œê·¸</h1>
            <div>
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house"></i> í™ˆ</a>
                <a href="admin.html" class="btn btn-secondary me-2"><i class="bi bi-gear"></i> ê´€ë¦¬ì</a>
                <button class="btn btn-warning me-2" id="notificationStatusBtn" onclick="requestNotificationPermission()">
                    <i class="bi bi-bell-slash" id="notificationIcon"></i> <span id="notificationStatusText">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</span>
                </button>
                <button class="btn btn-success" onclick="loadChanges()"><i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> ë³€í™” ë¡œê·¸</h5>
                <button class="btn btn-warning btn-sm" id="notificationStatusBtn2" onclick="requestNotificationPermission()">
                    <i class="bi bi-bell-slash" id="notificationIcon2"></i> <span id="notificationStatusText2">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</span>
                </button>
            </div>
            <div class="card-body p-0" id="changeList">
                <div class="text-center p-5"><div class="spinner-border text-info"></div></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lastChangeId = 0;
        let notificationPermission = false;
        
        $(document).ready(function() {
            checkNotificationPermission();
            loadChanges();
            // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œìš´ ë³€í™” ì²´í¬
            setInterval(checkNewChanges, 5000);
        });
        
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                    updateNotificationUI('granted');
                } else if (Notification.permission === 'denied') {
                    notificationPermission = false;
                    updateNotificationUI('denied');
                } else {
                    notificationPermission = false;
                    updateNotificationUI('default');
                }
            } else {
                updateNotificationUI('not-supported');
            }
        }
        
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            Notification.requestPermission().then(function(permission) {
                notificationPermission = permission === 'granted';
                updateNotificationUI(permission);
                
                if (notificationPermission) {
                    alert('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ë³€í™”ê°€ ê°ì§€ë˜ë©´ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.');
                    // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
                    showTestNotification();
                } else {
                    alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }).catch(function(err) {
                console.error('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
                alert('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        function updateNotificationUI(permission) {
            // ìƒë‹¨ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const btn = $('#notificationStatusBtn');
            const icon = $('#notificationIcon');
            const text = $('#notificationStatusText');
            
            // ì¹´ë“œ í—¤ë” ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const btn2 = $('#notificationStatusBtn2');
            const icon2 = $('#notificationIcon2');
            const text2 = $('#notificationStatusText2');
            
            if (permission === 'granted') {
                btn.removeClass('btn-warning').addClass('btn-success');
                icon.removeClass('bi-bell-slash').addClass('bi-bell-fill');
                text.text('ì•Œë¦¼ í™œì„±í™”ë¨');
                
                btn2.removeClass('btn-warning').addClass('btn-success');
                icon2.removeClass('bi-bell-slash').addClass('bi-bell-fill');
                text2.text('ì•Œë¦¼ í™œì„±í™”ë¨');
            } else if (permission === 'denied') {
                btn.removeClass('btn-warning btn-success').addClass('btn-danger');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê±°ë¶€ë¨');
                
                btn2.removeClass('btn-warning btn-success').addClass('btn-danger');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ê±°ë¶€ë¨');
            } else if (permission === 'not-supported') {
                btn.removeClass('btn-warning btn-success').addClass('btn-secondary');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ë¯¸ì§€ì›');
                
                btn2.removeClass('btn-warning btn-success').addClass('btn-secondary');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ë¯¸ì§€ì›');
            } else {
                btn.removeClass('btn-success btn-danger').addClass('btn-warning');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­');
                
                btn2.removeClass('btn-success btn-danger').addClass('btn-warning');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­');
            }
        }
        
        function showTestNotification() {
            if (notificationPermission) {
                const notification = new Notification('ì•Œë¦¼ í…ŒìŠ¤íŠ¸', {
                    body: 'ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!',
                    icon: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/globe.svg',
                    tag: 'test-notification'
                });
                
                setTimeout(function() {
                    notification.close();
                }, 3000);
            }
        }
        
        function checkNewChanges() {
            // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ ì¬í™•ì¸
            if ('Notification' in window) {
                notificationPermission = Notification.permission === 'granted';
            }
            
            $.ajax({
                url: 'api/get_new_changes.php',
                method: 'GET',
                data: { last_change_id: lastChangeId },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success && response.data && response.data.length > 0) {
                        console.log('ìƒˆë¡œìš´ ë³€í™” ê°ì§€:', response.data.length, 'ê°œ');
                        
                        // ìƒˆë¡œìš´ ë³€í™”ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ
                        response.data.forEach(function(change) {
                            if (change.change_id > lastChangeId) {
                                lastChangeId = change.change_id;
                            }
                            
                            if (notificationPermission) {
                                showNotification(change);
                            }
                        });
                        
                        // í˜ì´ì§€ê°€ ë³´ì´ëŠ” ìƒíƒœë©´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                        if (!document.hidden) {
                            loadChanges();
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ìƒˆ ë³€í™” ì²´í¬ ì‹¤íŒ¨:', error);
                }
            });
        }
        
        function showNotification(change) {
            if (!notificationPermission) {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì—†ì–´ ì•Œë¦¼ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const title = 'ğŸ”” ë³€í™” ê°ì§€: ' + (change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ');
            const body = 'ìƒˆë¡œìš´ ë³€í™”ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‹œê°„: ' + (change.detected_at || 'ë°©ê¸ˆ ì „');
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/globe.svg',
                    badge: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/bell-fill.svg',
                    tag: 'monitor-change-' + change.change_id,
                    requireInteraction: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // 10ì´ˆ í›„ ìë™ ë‹«ê¸°
                setTimeout(function() {
                    notification.close();
                }, 10000);
                
                console.log('ì•Œë¦¼ í‘œì‹œë¨:', title);
            } catch (error) {
                console.error('ì•Œë¦¼ í‘œì‹œ ì‹¤íŒ¨:', error);
            }
        }

        function loadChanges() {
            $.ajax({
                url: 'api/get_changes.php',
                method: 'GET',
                data: { limit: 100 },
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderChanges(response.data);
                        // ë§ˆì§€ë§‰ change_id ì—…ë°ì´íŠ¸
                        if (response.data && response.data.length > 0) {
                            lastChangeId = Math.max(lastChangeId, response.data[0].change_id);
                        }
                    } else {
                        $('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + (response?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    let errorMsg = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response && response.message) {
                            errorMsg = response.message;
                        }
                    } catch (e) {
                        if (xhr.responseText) {
                            errorMsg = xhr.responseText.substring(0, 200);
                        }
                    }
                    $('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + errorMsg + '</div>');
                }
            });
        }

        function renderChanges(changes) {
            if (!changes || changes.length === 0) {
                $('#changeList').html('<div class="text-center p-5 text-muted">ë³€í™” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }
            let html = '';
            changes.forEach(function(change) {
                const unreadClass = change.is_read == '0' ? 'unread' : '';
                const readBadge = change.is_read == '0' ? '<span class="badge bg-warning text-dark">NEW</span>' : '<span class="badge bg-secondary">ì½ìŒ</span>';
                html += `
                    <div class="change-item ${unreadClass}">
                        <h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning"></i> ${escapeHtml(change.site_name)} ${readBadge}</h5>
                        <p class="text-muted mb-2"><i class="bi bi-calendar-event"></i> ${change.detected_at}</p>
                        <div class="diff-content">${change.diff_html}</div>
                    </div>
                `;
            });
            $('#changeList').html(html);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

