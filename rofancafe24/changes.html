<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ ëª¨ë‹ˆí„°ë§ ë³€í™” ë¡œê·¸ - ì¹´í˜24</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 1600px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .change-item { border-bottom: 1px solid #e9ecef; padding: 20px; }
        .change-item.unread { background-color: #fff3cd; }
        .diff-content { background-color: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; line-height: 1.8; }
        .diff-added { background-color: #d4edda !important; color: #155724 !important; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .diff-removed { background-color: #f8d7da !important; color: #721c24 !important; text-decoration: line-through; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-clock-history"></i> ì›¹ ëª¨ë‹ˆí„°ë§ ë³€í™” ë¡œê·¸</h1>
            <div>
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house"></i> í™ˆ</a>
                <a href="admin.html" class="btn btn-secondary me-2"><i class="bi bi-gear"></i> ê´€ë¦¬ì</a>
                <a href="site_logs.html" class="btn btn-primary me-2"><i class="bi bi-list-check"></i> ì‚¬ì´íŠ¸ë³„ ë¡œê·¸</a>
                <button class="btn btn-warning me-2" id="notificationStatusBtn" onclick="requestNotificationPermission()">
                    <i class="bi bi-bell-slash" id="notificationIcon"></i> <span id="notificationStatusText">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</span>
                </button>
                <button class="btn btn-success" onclick="loadChanges()"><i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> ë³€í™” ë¡œê·¸</h5>
                <button class="btn btn-warning btn-sm" id="notificationStatusBtn2" onclick="requestNotificationPermission()">
                    <i class="bi bi-bell-slash" id="notificationIcon2"></i> <span id="notificationStatusText2">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</span>
                </button>
            </div>
            <div class="card-body p-0" id="changeList">
                <div id="attendanceInfo" style="background-color: #fff3cd; padding: 15px; border-bottom: 2px solid #ffc107; margin: 0;">
                    <div class="text-center"><div class="spinner-border spinner-border-sm text-warning"></div> ì¶œê·¼ë¶€ ì •ë³´ ë¡œë”© ì¤‘...</div>
                </div>
                <div class="text-center p-5"><div class="spinner-border text-info"></div></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // jQuery ë¡œë“œ í™•ì¸
        if (typeof jQuery === 'undefined') {
            document.getElementById('changeList').innerHTML = '<div class="alert alert-danger m-3">jQueryë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
        }
        
        let lastChangeId = 0;
        let notificationPermission = false;
        let notifiedChangeIds = new Set(); // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ change_id ì¶”ì 
        
        // jQueryê°€ ë¡œë“œëœ í›„ ì‹¤í–‰
        (function() {
            if (typeof jQuery !== 'undefined') {
                jQuery(document).ready(function($) {
                    try {
                        checkNotificationPermission();
                        loadTodayAttendance();
                        loadChanges();
                        // 1ì´ˆë§ˆë‹¤ ìƒˆë¡œìš´ ë³€í™” ì²´í¬
                        setInterval(checkNewChanges, 1000);
                        // 1ì´ˆë§ˆë‹¤ ì¶œê·¼ë¶€ ì •ë³´ ì—…ë°ì´íŠ¸
                        setInterval(loadTodayAttendance, 1000);
                    } catch (error) {
                        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                        if (typeof jQuery !== 'undefined') {
                            jQuery('#changeList').html('<div class="alert alert-danger m-3">í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>');
                        } else {
                            document.getElementById('changeList').innerHTML = '<div class="alert alert-danger m-3">í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                        }
                    }
                });
            } else {
                // jQueryê°€ ì—†ì„ ë•Œ í´ë°±
                window.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('changeList').innerHTML = '<div class="alert alert-danger m-3">jQueryë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</div>';
                });
            }
        })();
        
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                    updateNotificationUI('granted');
                } else if (Notification.permission === 'denied') {
                    notificationPermission = false;
                    updateNotificationUI('denied');
                } else {
                    notificationPermission = false;
                    updateNotificationUI('default');
                }
            } else {
                updateNotificationUI('not-supported');
            }
        }
        
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            Notification.requestPermission().then(function(permission) {
                notificationPermission = permission === 'granted';
                updateNotificationUI(permission);
                
                // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ AudioContext ì´ˆê¸°í™”
                initAudioContext();
                
                if (notificationPermission) {
                    alert('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ë³€í™”ê°€ ê°ì§€ë˜ë©´ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.');
                    // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
                    showTestNotification();
                } else {
                    alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }).catch(function(err) {
                console.error('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', err);
                alert('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        function updateNotificationUI(permission) {
            if (typeof jQuery === 'undefined') {
                return;
            }
            
            // ìƒë‹¨ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const btn = jQuery('#notificationStatusBtn');
            const icon = jQuery('#notificationIcon');
            const text = jQuery('#notificationStatusText');
            
            // ì¹´ë“œ í—¤ë” ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const btn2 = jQuery('#notificationStatusBtn2');
            const icon2 = jQuery('#notificationIcon2');
            const text2 = jQuery('#notificationStatusText2');
            
            if (permission === 'granted') {
                btn.removeClass('btn-warning').addClass('btn-success');
                icon.removeClass('bi-bell-slash').addClass('bi-bell-fill');
                text.text('ì•Œë¦¼ í™œì„±í™”ë¨');
                
                btn2.removeClass('btn-warning').addClass('btn-success');
                icon2.removeClass('bi-bell-slash').addClass('bi-bell-fill');
                text2.text('ì•Œë¦¼ í™œì„±í™”ë¨');
            } else if (permission === 'denied') {
                btn.removeClass('btn-warning btn-success').addClass('btn-danger');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê±°ë¶€ë¨');
                
                btn2.removeClass('btn-warning btn-success').addClass('btn-danger');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ê±°ë¶€ë¨');
            } else if (permission === 'not-supported') {
                btn.removeClass('btn-warning btn-success').addClass('btn-secondary');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ë¯¸ì§€ì›');
                
                btn2.removeClass('btn-warning btn-success').addClass('btn-secondary');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ë¯¸ì§€ì›');
            } else {
                btn.removeClass('btn-success btn-danger').addClass('btn-warning');
                icon.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text.text('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­');
                
                btn2.removeClass('btn-success btn-danger').addClass('btn-warning');
                icon2.removeClass('bi-bell-fill').addClass('bi-bell-slash');
                text2.text('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­');
            }
        }
        
        function showTestNotification() {
            if (notificationPermission) {
                const notification = new Notification('ì•Œë¦¼ í…ŒìŠ¤íŠ¸', {
                    body: 'ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!',
                    icon: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/globe.svg',
                    tag: 'test-notification'
                });
                
                setTimeout(function() {
                    notification.close();
                }, 3000);
            }
        }
        
        function checkNewChanges() {
            if (typeof jQuery === 'undefined') {
                return;
            }
            
            // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ ì¬í™•ì¸
            if ('Notification' in window) {
                notificationPermission = Notification.permission === 'granted';
            }
            
            jQuery.ajax({
                url: 'api/get_new_changes.php',
                method: 'GET',
                data: { last_change_id: lastChangeId },
                dataType: 'json',
                timeout: 5000,
                success: function(response) {
                    try {
                        if (response && response.success && response.data && response.data.length > 0) {
                            console.log('ìƒˆë¡œìš´ ë³€í™” ê°ì§€:', response.data.length, 'ê°œ');
                            
                            // ìƒˆë¡œìš´ ë³€í™”ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
                            response.data.forEach(function(change) {
                                if (change.change_id > lastChangeId) {
                                    lastChangeId = change.change_id;
                                }
                                
                                // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ change_idëŠ” ê±´ë„ˆë›°ê¸°
                                if (!notifiedChangeIds.has(change.change_id) && notificationPermission) {
                                    notifiedChangeIds.add(change.change_id);
                                    showNotification(change);
                                }
                            });
                            
                            // í˜ì´ì§€ê°€ ë³´ì´ëŠ” ìƒíƒœë©´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                            if (!document.hidden) {
                                loadChanges();
                            }
                        }
                    } catch (error) {
                        console.error('ìƒˆ ë³€í™” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    }
                },
                error: function(xhr, status, error) {
                    // ì¡°ìš©íˆ ì‹¤íŒ¨ (ì—ëŸ¬ ë¡œê·¸ë§Œ)
                    console.error('ìƒˆ ë³€í™” ì²´í¬ ì‹¤íŒ¨:', error);
                }
            });
        }
        
        function showNotification(change) {
            if (!notificationPermission) {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì—†ì–´ ì•Œë¦¼ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë³€ê²½ ë‚´ì—­ ì¶”ì¶œ (diff_htmlì—ì„œ í…ìŠ¤íŠ¸ë§Œ)
            let changeSummary = '';
            if (change.diff_html) {
                // HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = change.diff_html;
                let text = tempDiv.textContent || tempDiv.innerText || '';
                
                // ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸° (100ì ì œí•œ)
                if (text.length > 100) {
                    text = text.substring(0, 100) + '...';
                }
                
                // ë¹¨ê°„ìƒ‰(ì‚­ì œ)ê³¼ ì´ˆë¡ìƒ‰(ì¶”ê°€) í…ìŠ¤íŠ¸ ì¶”ì¶œ
                const removedMatches = change.diff_html.match(/<span[^>]*class="[^"]*diff-removed[^"]*"[^>]*>([^<]+)<\/span>/g);
                const addedMatches = change.diff_html.match(/<span[^>]*class="[^"]*diff-added[^"]*"[^>]*>([^<]+)<\/span>/g);
                
                let removedText = '';
                let addedText = '';
                
                if (removedMatches && removedMatches.length > 0) {
                    removedText = removedMatches.map(m => {
                        const match = m.match(/>([^<]+)</);
                        return match ? match[1] : '';
                    }).filter(t => t).join(' ');
                }
                
                if (addedMatches && addedMatches.length > 0) {
                    addedText = addedMatches.map(m => {
                        const match = m.match(/>([^<]+)</);
                        return match ? match[1] : '';
                    }).filter(t => t).join(' ');
                }
                
                // ì‹¤ì œë¡œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ê³µí†µ ë¶€ë¶„ ì œì™¸)
                if (removedText && addedText) {
                    // ê³µí†µ prefixì™€ suffix ì°¾ê¸°
                    const commonPrefix = findCommonPrefix(removedText, addedText);
                    const commonSuffix = findCommonSuffix(removedText, addedText);
                    
                    let removedDiff = removedText;
                    let addedDiff = addedText;
                    
                    if (commonPrefix) {
                        removedDiff = removedText.substring(commonPrefix.length);
                        addedDiff = addedText.substring(commonPrefix.length);
                    }
                    if (commonSuffix && removedDiff.endsWith(commonSuffix) && addedDiff.endsWith(commonSuffix)) {
                        removedDiff = removedDiff.substring(0, removedDiff.length - commonSuffix.length);
                        addedDiff = addedDiff.substring(0, addedDiff.length - commonSuffix.length);
                    }
                    
                    // ì‹¤ì œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ í‘œì‹œ
                    changeSummary = '';
                    if (removedDiff) {
                        changeSummary += 'âŒ ì‚­ì œ: ' + removedDiff;
                    }
                    if (addedDiff) {
                        if (changeSummary) changeSummary += '\n';
                        changeSummary += 'âœ… ì¶”ê°€: ' + addedDiff;
                    }
                    
                    // ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸°
                    if (changeSummary.length > 100) {
                        changeSummary = changeSummary.substring(0, 100) + '...';
                    }
                } else if (removedText) {
                    changeSummary = 'âŒ ì‚­ì œ: ' + (removedText.length > 50 ? removedText.substring(0, 50) + '...' : removedText);
                } else if (addedText) {
                    changeSummary = 'âœ… ì¶”ê°€: ' + (addedText.length > 50 ? addedText.substring(0, 50) + '...' : addedText);
                } else {
                    changeSummary = text || 'ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }
            } else {
                changeSummary = 'ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
            const title = 'ğŸ”” ë³€í™” ê°ì§€: ' + (change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ');
            const body = changeSummary + '\n\nì‹œê°„: ' + (change.detected_at || 'ë°©ê¸ˆ ì „');
            
            // ì†Œë¦¬ ì¬ìƒ
            playNotificationSound();
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/globe.svg',
                    badge: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/icons/bell-fill.svg',
                    tag: 'monitor-change-' + change.change_id,
                    requireInteraction: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // 10ì´ˆ í›„ ìë™ ë‹«ê¸°
                setTimeout(function() {
                    notification.close();
                }, 10000);
                
                console.log('ì•Œë¦¼ í‘œì‹œë¨:', title);
            } catch (error) {
                console.error('ì•Œë¦¼ í‘œì‹œ ì‹¤íŒ¨:', error);
            }
        }
        
        let audioContext = null;
        let soundEnabled = false;
        
        // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ AudioContext ì´ˆê¸°í™”
        function initAudioContext() {
            if (audioContext) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                soundEnabled = true;
            } catch (error) {
                console.log('AudioContext ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì—¬ëŸ¬ ë²ˆ ê°€ëŠ¥í•˜ë„ë¡)
        document.addEventListener('click', function() {
            initAudioContext();
        });
        
        document.addEventListener('keydown', function() {
            initAudioContext();
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì‘ë™)
        setTimeout(function() {
            initAudioContext();
        }, 1000);
        
        function playNotificationSound() {
            // ë°©ë²• 1: Web Audio API ì‹œë„
            if (!audioContext) {
                try {
                    initAudioContext();
                } catch (error) {
                    console.log('AudioContext ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }
            }
            
            if (audioContext && soundEnabled) {
                try {
                    // AudioContextê°€ suspended ìƒíƒœë©´ resume
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(function() {
                            playWebAudioSound();
                        }).catch(function(err) {
                            console.log('AudioContext resume ì‹¤íŒ¨:', err);
                            playFallbackSound();
                        });
                    } else {
                        playWebAudioSound();
                    }
                    return;
                } catch (error) {
                    console.log('Web Audio ì¬ìƒ ì‹¤íŒ¨:', error);
                }
            }
            
            // ë°©ë²• 2: Fallback - Data URLì„ ì‚¬ìš©í•œ ê°„ë‹¨í•œ beep
            playFallbackSound();
        }
        
        function playWebAudioSound() {
            // ëµë™ ì†Œë¦¬ (ë‘ ë²ˆì˜ í†¤)
            function playTone(frequency, startTime, duration) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }
            
            const now = audioContext.currentTime;
            playTone(800, now, 0.2);      // ì²« ë²ˆì§¸ í†¤ (ëµ)
            playTone(1000, now + 0.25, 0.3); // ë‘ ë²ˆì§¸ í†¤ (ë™)
        }
        
        function playFallbackSound() {
            // ì‹¤ì œ ì‚¬ìš´ë“œ íŒŒì¼ ì‚¬ìš© (ì—¬ëŸ¬ í˜•ì‹ ì‹œë„)
            const soundFiles = [
                'a.mp3',
                'a.wav',
                'a.ogg',
                'notification.mp3',
                'notification.wav',
                'beep.mp3',
                'beep.wav'
            ];
            
            let soundPlayed = false;
            let attempts = 0;
            const maxAttempts = soundFiles.length;
            
            function tryPlaySound(index) {
                if (index >= soundFiles.length || soundPlayed) {
                    if (!soundPlayed && attempts >= maxAttempts) {
                        // ëª¨ë“  íŒŒì¼ ì‹¤íŒ¨ ì‹œ Data URL ì‚¬ìš©
                        playDataUrlSound();
                    }
                    return;
                }
                
                const soundFile = soundFiles[index];
                attempts++;
                
                try {
                    const audio = new Audio(soundFile);
                    audio.volume = 0.7;
                    
                    // ì„±ê³µ ì‹œ ì¬ìƒ
                    audio.addEventListener('canplaythrough', function() {
                        if (!soundPlayed) {
                            soundPlayed = true;
                            audio.play().then(function() {
                                console.log('ì‚¬ìš´ë“œ ì¬ìƒ ì„±ê³µ:', soundFile);
                            }).catch(function(err) {
                                console.log('Audio ì¬ìƒ ì‹¤íŒ¨:', soundFile, err);
                                soundPlayed = false;
                                tryPlaySound(index + 1);
                            });
                        }
                    }, { once: true });
                    
                    // ì—ëŸ¬ ì‹œ ë‹¤ìŒ íŒŒì¼ ì‹œë„
                    audio.addEventListener('error', function(e) {
                        console.log('Audio ë¡œë“œ ì‹¤íŒ¨:', soundFile, e);
                        if (!soundPlayed) {
                            tryPlaySound(index + 1);
                        }
                    }, { once: true });
                    
                    // ë¡œë“œ ì‹œì‘
                    audio.load();
                    
                    // ì¦‰ì‹œ ì¬ìƒ ì‹œë„ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì‘ë™)
                    audio.play().then(function() {
                        if (!soundPlayed) {
                            soundPlayed = true;
                            console.log('ì‚¬ìš´ë“œ ì¦‰ì‹œ ì¬ìƒ ì„±ê³µ:', soundFile);
                        }
                    }).catch(function(err) {
                        // ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  canplaythrough ì´ë²¤íŠ¸ ëŒ€ê¸°
                        console.log('ì¦‰ì‹œ ì¬ìƒ ì‹¤íŒ¨ (ëŒ€ê¸° ì¤‘):', soundFile, err.message);
                    });
                } catch (error) {
                    console.log('Audio ìƒì„± ì‹¤íŒ¨:', soundFile, error);
                    tryPlaySound(index + 1);
                }
            }
            
            // ì²« ë²ˆì§¸ íŒŒì¼ë¶€í„° ì‹œë„
            tryPlaySound(0);
        }
        
        function playDataUrlSound() {
            // Data URLì„ ì‚¬ìš©í•œ fallback
            const beepDataUrl = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OSfTQ8OUKbl8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDkn00PDlCm5fC2YxwGOJHX8sx5LAUkd8fw3ZBAC';
            
            try {
                const audio = new Audio(beepDataUrl);
                audio.volume = 0.5;
                audio.play().catch(function(err) {
                    console.log('Data URL Audio ì¬ìƒ ì‹¤íŒ¨:', err);
                });
            } catch (error) {
                console.log('Data URL Audio ìƒì„± ì‹¤íŒ¨:', error);
            }
        }
        
        function findCommonPrefix(str1, str2) {
            let prefix = '';
            const minLen = Math.min(str1.length, str2.length);
            for (let i = 0; i < minLen; i++) {
                if (str1[i] === str2[i]) {
                    prefix += str1[i];
                } else {
                    break;
                }
            }
            return prefix;
        }
        
        function findCommonSuffix(str1, str2) {
            let suffix = '';
            const minLen = Math.min(str1.length, str2.length);
            for (let i = 1; i <= minLen; i++) {
                if (str1[str1.length - i] === str2[str2.length - i]) {
                    suffix = str1[str1.length - i] + suffix;
                } else {
                    break;
                }
            }
            return suffix;
        }

        function loadChanges() {
            if (typeof jQuery === 'undefined') {
                document.getElementById('changeList').innerHTML = '<div class="alert alert-danger m-3">jQueryê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            jQuery.ajax({
                url: 'api/get_changes.php',
                method: 'GET',
                data: { limit: 200 },  // ë” ë§ì€ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
                dataType: 'json',
                timeout: 10000,
                success: function(response) {
                    try {
                        if (response && response.success) {
                            renderChanges(response.data);
                            // ë§ˆì§€ë§‰ change_id ì—…ë°ì´íŠ¸
                        if (response.data && response.data.length > 0) {
                            lastChangeId = Math.max(lastChangeId, response.data[0].change_id);
                            // ì´ë¯¸ í‘œì‹œí•œ change_idë„ ì—…ë°ì´íŠ¸
                            response.data.forEach(function(change) {
                                notifiedChangeIds.add(change.change_id);
                            });
                        }
                        } else {
                            jQuery('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + (response && response.message ? response.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>');
                        }
                    } catch (error) {
                        console.error('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                        jQuery('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {status: status, error: error, response: xhr.responseText});
                    let errorMsg = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                    try {
                        if (xhr.responseText) {
                            const response = JSON.parse(xhr.responseText);
                            if (response && response.message) {
                                errorMsg = response.message;
                            } else {
                                errorMsg = xhr.responseText.substring(0, 200);
                            }
                        }
                    } catch (e) {
                        if (xhr.responseText) {
                            errorMsg = xhr.responseText.substring(0, 200);
                        } else {
                            errorMsg = error || status || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                        }
                    }
                    jQuery('#changeList').html('<div class="alert alert-danger m-3">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + errorMsg + '<br><small>ìƒíƒœ: ' + status + '</small></div>');
                }
            });
        }

        function renderChanges(changes) {
            if (typeof jQuery === 'undefined') {
                return;
            }
            
            if (!changes || changes.length === 0) {
                jQuery('#changeList').html('<div class="text-center p-5 text-muted">ë³€í™” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }
            let html = '';
            changes.forEach(function(change) {
                const unreadClass = change.is_read == '0' ? 'unread' : '';
                const readBadge = change.is_read == '0' ? '<span class="badge bg-warning text-dark">NEW</span>' : '<span class="badge bg-secondary">ì½ìŒ</span>';
                const siteName = change.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                html += `
                    <div class="change-item ${unreadClass}">
                        <h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning"></i> ${escapeHtml(siteName)} ${readBadge}</h5>
                        <p class="text-muted mb-2"><i class="bi bi-calendar-event"></i> ${change.detected_at || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                        <div class="diff-content">${change.diff_html || 'ë³€í™” ë‚´ìš© ì—†ìŒ'}</div>
                    </div>
                `;
            });
            // ì¶œê·¼ë¶€ ì •ë³´ëŠ” ìœ ì§€í•˜ê³  ë³€í™” ë¡œê·¸ë§Œ ì¶”ê°€
            const attendanceHtml = jQuery('#attendanceInfo').html();
            jQuery('#changeList').html(attendanceHtml + html);
        }
        
        function loadTodayAttendance() {
            if (typeof jQuery === 'undefined') return;
            
            jQuery.ajax({
                url: 'api/get_today_attendance.php',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        renderAttendanceInfo(response.data);
                    }
                },
                error: function() {
                    // ì—ëŸ¬ ì‹œ ë¬´ì‹œ (ì¶œê·¼ë¶€ ì •ë³´ê°€ ì—†ì„ ìˆ˜ë„ ìˆìŒ)
                }
            });
        }
        
        function renderAttendanceInfo(attendanceRecords) {
            if (typeof jQuery === 'undefined') return;
            
            if (!attendanceRecords || attendanceRecords.length === 0) {
                jQuery('#attendanceInfo').html('<div style="text-align: center; padding: 10px; color: #856404;"><i class="bi bi-info-circle"></i> ì¶œê·¼ì¸ì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
                return;
            }
            
            // ì‚¬ì´íŠ¸ë³„ë¡œ ê·¸ë£¹í™”
            let siteGroups = {};
            attendanceRecords.forEach(function(record) {
                const siteName = record.site_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                if (!siteGroups[siteName]) {
                    siteGroups[siteName] = [];
                }
                siteGroups[siteName].push(record);
            });
            
            let html = '<div style="font-weight: bold; margin-bottom: 10px; color: #856404;"><i class="bi bi-calendar-check"></i> ì˜¤ëŠ˜ ì¶œê·¼ë¶€ (' + new Date().toLocaleDateString('ko-KR') + ')</div>';
            
            Object.keys(siteGroups).forEach(function(siteName) {
                html += '<div style="margin-bottom: 8px;"><strong>' + escapeHtml(siteName) + ':</strong> ';
                let staffList = [];
                siteGroups[siteName].forEach(function(record) {
                    const times = record.work_times || '';
                    staffList.push(escapeHtml(record.staff_name) + ' ' + escapeHtml(times));
                });
                html += staffList.join(' | ') + '</div>';
            });
            
            jQuery('#attendanceInfo').html(html);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

