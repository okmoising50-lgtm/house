# 성능 및 과부하 관련 정보

## 시스템 구조

이 모니터링 시스템은 다음과 같이 구성되어 있습니다:

1. **카페24 서버 (rofan.mycafe24.com)**
   - PHP + MySQL (MariaDB)
   - 웹 인터페이스 (admin.html, changes.html, site_logs.html)
   - API 엔드포인트 (get_sites.php, get_changes.php, save_site.php 등)
   - 데이터베이스 (monitor_sites, monitor_snapshots, monitor_changes)

2. **GCP 서버 (45.120.69.179)**
   - Python 크롤러 (GCP_CRAWLER.py)
   - 사이트를 주기적으로 체크하고 변화를 감지
   - 카페24 서버의 API를 호출하여 결과 저장

## 과부하 발생 위치 및 증상

### 1. 카페24 서버 (PHP + MySQL) 과부하

**발생 가능한 상황:**
- 1초마다 새로고침하는 사용자가 많을 때
- 동시에 여러 사용자가 페이지를 열어둘 때
- 데이터베이스 쿼리가 많을 때

**증상:**
- 페이지 로딩이 느려짐
- AJAX 요청이 타임아웃됨
- 데이터베이스 연결 오류 발생
- "서버 연결 실패" 메시지 표시
- PHP 에러 로그에 "Too many connections" 오류
- MySQL 프로세스 리스트에 많은 쿼리가 대기 중

**해결 방법:**
- 새로고침 주기를 늘리기 (1초 → 3초 또는 5초)
- 데이터베이스 연결 풀 최적화
- 불필요한 쿼리 최적화
- 캐싱 활용

### 2. GCP 서버 (Python 크롤러) 과부하

**발생 가능한 상황:**
- 모니터링 사이트가 많을 때
- 체크 주기가 너무 짧을 때 (예: 1초)
- 각 사이트의 응답이 느릴 때

**증상:**
- 크롤러가 사이트를 체크하지 못함
- "마지막 체크" 시간이 업데이트되지 않음
- 크롤러 로그에 에러 메시지
- CPU 사용률이 높아짐
- 메모리 사용량 증가
- 네트워크 타임아웃 발생

**해결 방법:**
- 체크 주기를 적절히 설정 (최소 5초 권장)
- 사이트 간 간격 조정 (현재 1초)
- 타임아웃 설정 조정
- 크롤러를 여러 인스턴스로 분산

### 3. 모니터링 대상 사이트 과부하

**발생 가능한 상황:**
- 크롤러가 너무 자주 접속할 때
- 동시에 여러 크롤러가 접속할 때

**증상:**
- 모니터링 대상 사이트가 느려짐
- 접근이 차단될 수 있음 (IP 차단)
- 429 Too Many Requests 오류
- 503 Service Unavailable 오류

**해결 방법:**
- 체크 주기를 적절히 설정
- User-Agent 설정
- 요청 간격 조정

## 권장 설정

### 체크 주기
- **최소**: 5초 (권장)
- **일반**: 10-30초
- **낮은 우선순위**: 60초 이상

### 새로고침 주기
- **실시간 모니터링**: 1-3초
- **일반 사용**: 5-10초
- **배터리 절약**: 30초 이상

### 데이터베이스 최적화
- 스냅샷 정리 스크립트를 정기적으로 실행
- 오래된 로그 삭제 (선택사항)
- 인덱스 최적화

## 모니터링 방법

### 카페24 서버 상태 확인
```sql
-- 활성 연결 수 확인
SHOW PROCESSLIST;

-- 테이블 크기 확인
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = 'rofan'
ORDER BY (data_length + index_length) DESC;
```

### GCP 크롤러 상태 확인
```bash
# 크롤러 프로세스 확인
ps aux | grep GCP_CRAWLER.py

# 크롤러 로그 확인
tail -f crawler.log

# CPU/메모리 사용량 확인
top -p $(pgrep -f GCP_CRAWLER.py)
```

## 성능 최적화 팁

1. **불필요한 쿼리 줄이기**
   - 페이지가 보이지 않을 때는 업데이트 중지 (이미 구현됨)
   - 캐싱 활용

2. **데이터베이스 최적화**
   - 인덱스 추가
   - 오래된 데이터 정리
   - 쿼리 최적화

3. **크롤러 최적화**
   - 사이트별 체크 주기 조정
   - 타임아웃 설정
   - 에러 처리 개선

4. **네트워크 최적화**
   - CDN 활용 (선택사항)
   - 압축 활성화
   - 불필요한 요청 줄이기



